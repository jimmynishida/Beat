<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>時光節拍</title>
  <style>
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      text-align: center;
    }
    .song-selector {
      margin-top: 20px;
    }
    .song-button {
      background: #ff4081;
      border: none;
      margin: 10px;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      color: white;
    }
    #tap-area {
      width: 200px;
      height: 200px;
      margin: 30px auto;
      border-radius: 50%;
      background: radial-gradient(#ffc107, #ff9800);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: transform 0.1s ease;
    }
    #tap-area:active {
      transform: scale(0.95);
    }
    #progress-bar {
      width: 80%;
      margin: auto;
      height: 10px;
      background: #444;
      border-radius: 5px;
      overflow: hidden;
    }
    #progress {
      height: 100%;
      width: 0%;
      background: #ff4081;
    }
    #score {
      margin-top: 10px;
      font-size: 18px;
    }
    #medal {
      width: 120px;
      margin: 20px auto;
      display: none;
    }
    #share-btn {
      background: #2196f3;
      color: white;
      padding: 8px 16px;
      margin: 10px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>
  <h1>時光節拍 🎶</h1>
  <div class="song-selector">
    <button class="song-button" onclick="loadSong('甜蜜蜜')">甜蜜蜜</button>
    <button class="song-button" onclick="loadSong('童年')">童年</button>
    <button class="song-button" onclick="loadSong('男兒當自強')">男兒當自強</button>
    <button class="song-button" onclick="loadSong('很愛很愛你')">很愛很愛你</button>
    <button class="song-button" onclick="loadSong('瀟灑走一回')">瀟灑走一回</button>
    <button class="song-button" onclick="loadSong('月亮代表我的心')">月亮代表我的心</button>
  </div>

  <div id="tap-area">點擊節奏</div>
  <div id="progress-bar"><div id="progress"></div></div>
  <div id="score">得分：0</div>
  <img id="medal" src="medal.png" alt="勳章" />
  <button id="share-btn" onclick="shareResult()">分享成績</button>

  <audio id="song"></audio>
  <canvas id="canvas" style="display:none;"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const songMap = {
      "甜蜜蜜": "sweet",
      "童年": "childhood",
      "男兒當自強": "hero",
      "很愛很愛你": "verylove",
      "瀟灑走一回": "freewalk",
      "月亮代表我的心": "moon"
    };

    let score = 0;
    let chart = [];
    let currentIndex = 0;
    let gameStarted = false;
    let selectedSong = "";
    const song = document.getElementById("song");
    const tapArea = document.getElementById("tap-area");
    const scoreDisplay = document.getElementById("score");
    const progressBar = document.getElementById("progress");
    const medal = document.getElementById("medal");
    const shareBtn = document.getElementById("share-btn");

    function loadSong(displayName) {
      const fileName = songMap[displayName];
      score = 0;
      chart = [];
      currentIndex = 0;
      gameStarted = false;
      selectedSong = displayName;
      scoreDisplay.innerText = "得分：0";
      medal.style.display = "none";
      shareBtn.style.display = "none";
      song.src = `audio/${fileName}.mp3`;
      fetch(`audio/${fileName}.json`)
        .then(res => res.json())
        .then(data => {
          chart = data;
          tapArea.onclick = () => {
            if (!gameStarted) {
              song.play();
              gameStarted = true;
              startGame();
              setTimeout(endGame, song.duration * 1000);
            } else {
              checkTap();
            }
          };
        });
    }

    function startGame() {
      requestAnimationFrame(update);
    }

    function update() {
      if (!song.paused) {
        const t = song.currentTime;
        progressBar.style.width = (t / song.duration * 100) + "%";
        requestAnimationFrame(update);
      }
    }

    function checkTap() {
      if (!chart.length) return;
      const t = song.currentTime;
      const note = chart[currentIndex];
      if (note && Math.abs(note.time - t) < 0.4) {
        score += 100;
        scoreDisplay.innerText = "得分：" + score;
        currentIndex++;
        tapArea.style.background = "radial-gradient(#fff176, #f57f17)";
        setTimeout(() => {
          tapArea.style.background = "radial-gradient(#ffc107, #ff9800)";
        }, 150);
      }
    }

    function endGame() {
      medal.style.display = "block";
      shareBtn.style.display = "inline-block";
    }

    function shareResult() {
      html2canvas(document.body).then(canvas => {
        canvas.toBlob(blob => {
          const file = new File([blob], "score.png", { type: "image/png" });
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            navigator.share({
              title: "我在時光節拍的分數",
              text: `我在《${selectedSong}》拿到了 ${score} 分！快來試試看！`,
              files: [file]
            });
          } else {
            const link = document.createElement("a");
            link.download = "score.png";
            link.href = canvas.toDataURL();
            link.click();
          }
        });
      });
    }
  </script>
</body>
</html>
